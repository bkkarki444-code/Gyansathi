<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GyanSathi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #ffffff;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .chat-area {
            height: calc(100dvh - 130px);
            scrollbar-width: none;
        }
        .chat-area::-webkit-scrollbar { display: none; }

        .solution-block {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            border: 1px solid #e2e8f0;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 700;
            color: #0f172a;
        }

        .explanation-text {
            margin-top: 10px;
            font-size: 15px;
            line-height: 1.6;
            color: #334155;
            background: #fdfdfd;
            padding: 10px;
            border-radius: 8px;
        }

        .message-anim {
            animation: slide 0.2s ease-out forwards;
        }

        @keyframes slide {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <!-- ONBOARDING -->
    <div id="onboarding" class="fixed inset-0 z-50 bg-white flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <h1 class="text-4xl font-extrabold tracking-tighter text-slate-900 mb-8 text-center">GyanSathi</h1>
            <div class="space-y-4">
                <input id="userName" type="text" placeholder="Name" class="w-full p-4 bg-slate-100 rounded-2xl outline-none border-none font-semibold">
                <div class="flex gap-3">
                    <input id="userAge" type="number" placeholder="Age" class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none font-semibold">
                    <input id="userGrade" type="number" placeholder="Class (1-12)" class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none font-semibold">
                </div>
                <select id="userLang" class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-bold">
                    <option value="English">English</option>
                    <option value="Nepali">Nepali</option>
                </select>
                <button onclick="startApp()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold text-lg active:scale-95 transition-all">Start</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="h-screen flex flex-col w-full max-w-2xl mx-auto relative bg-white">
        <header class="p-4 border-b flex justify-between items-center bg-white z-10">
            <h2 class="font-bold text-xl tracking-tight text-slate-900">GyanSathi</h2>
            <div id="gradeTag" class="text-[10px] font-bold bg-slate-100 px-2 py-1 rounded-md text-slate-500 uppercase">Mentor</div>
        </header>

        <main id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4 chat-area"></main>

        <footer class="p-4 bg-white border-t">
            <div class="relative flex items-center gap-2">
                <input id="userInput" type="text" placeholder="Ask anything..." class="flex-1 p-4 bg-slate-100 rounded-2xl outline-none font-medium text-slate-700">
                <button id="sendBtn" onclick="handleSend()" class="p-4 bg-slate-900 text-white rounded-2xl active:scale-90 transition-all">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
            <p class="text-center text-[7px] font-bold text-slate-300 mt-2 tracking-widest uppercase">By Bijaya Karki</p>
        </footer>
    </div>

    <script>
        let profile = {};
        let chatHistory = [];
        const apiKey = "AIzaSyCt-mVIXOGROzAs13fcLOeoz0PV2lkS2_A"; 

        const systemPrompt = `You are GyanSathi, an elite mentor for students (Class 1-12).
        CORE BEHAVIOR:
        1. MEMORY: You have access to previous messages. Use them to understand context (e.g., if user asks "Why?", refer to your previous answer).
        2. NO FLUFF: No greetings like "Hi [Name]" or "Good question". Just the answer.
        3. MATH PEDAGOGY:
           - Give the full solution first.
           - Crucial: Explain the "Why" behind steps (e.g., if converting 33.33%, explain that 33.33/100 = 1/3).
           - Teach the pattern so they can solve similar problems.
        4. SUBJECT ADAPTATION:
           - Science/Definitions: If they ask "What is...", give a 1-2 sentence direct answer.
           - If they ask "Why/How...", give a detailed logical reason.
           - Sense if they want a short or long answer based on the query.
        5. CLASS LEVELING:
           - Class 1-5: Use very simple analogies, basic words, and friendly tone.
           - Class 6-12: Use technical terms, professional academic tone, and higher logic.
        6. LANGUAGE: Strict. Nepali profile = Nepali answer. English profile = English answer.
        7. NO MARKDOWN: Do not use #, *, $, or symbols. Use plain text and clear headers like [Solution] and [Reasoning].`;

        function startApp() {
            const name = document.getElementById('userName').value;
            const grade = document.getElementById('userGrade').value;
            const lang = document.getElementById('userLang').value;
            if(!name || !grade) return;
            profile = { name, grade: parseInt(grade), lang };
            document.getElementById('onboarding').style.display = 'none';
            document.getElementById('gradeTag').innerText = `Class ${grade}`;
            addMessage('model', lang === 'Nepali' ? `स्वागत छ ${name}।` : `Welcome ${name}.`);
        }

        function addMessage(role, text) {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} message-anim`;
            
            let cleanText = text.replace(/[#*$_]{1,}/g, '');
            
            if (cleanText.toLowerCase().includes('[solution]')) {
                cleanText = cleanText.replace(/\[solution\]/gi, '<div class="solution-block">')
                                   .replace(/\[reasoning\]|\[explanation\]/gi, '</div><div class="explanation-text">');
                if (cleanText.includes('solution-block') && !cleanText.endsWith('</div>')) cleanText += '</div>';
            }

            div.innerHTML = `
                <div class="max-w-[95%] p-4 rounded-2xl ${
                    role === 'user' 
                    ? 'bg-slate-900 text-white rounded-tr-none' 
                    : 'bg-slate-50 text-slate-800 rounded-tl-none border border-slate-100'
                }">
                    ${cleanText.replace(/\n/g, '<br>')}
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
            
            // Store in memory
            chatHistory.push({ role, parts: [{ text: text }] });
            if (chatHistory.length > 10) chatHistory.shift(); // Keep last 10 turns
        }

        async function handleSend() {
            const input = document.getElementById('userInput');
            const btn = document.getElementById('sendBtn');
            const text = input.value.trim();
            if(!text || btn.disabled) return;
            
            input.value = '';
            addMessage('user', text);
            btn.disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: `${systemPrompt}\nStudent Profile: ${JSON.stringify(profile)}` }] },
                            ...chatHistory
                        ]
                    })
                });
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error.";
                addMessage('model', aiText);
            } catch (e) {
                addMessage('model', "System Offline.");
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>

